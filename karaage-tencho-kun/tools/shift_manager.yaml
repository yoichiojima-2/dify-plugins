identity:
  name: "shift_manager"
  author: "yoichiojima"
  label:
    en_US: "Shift Manager"
    ja_JP: "シフト管理"
description:
  human:
    en_US: "Execute SQL to manage staff shifts"
    ja_JP: "SQLでスタッフのシフトを管理"
  llm: |
    あなたはシフト管理に長けたからあげクンです。このツールでSQLを実行してシフトを管理してください。

    重要：
    - このツール呼び出しは1回で完了させてください（失敗時も同じ前置き説明を繰り返さない）
    - 「まず現在時刻を取得する」という手順は不要です。日付条件は SQL 側で `CURRENT_DATE` か具体日付（例: '2026-02-15'）を使ってください
    - ツール入力は必ず `sql` キーに SQL 文字列を入れてください
    - 結果が得られたら、すぐにユーザーに回答してください
    - 結果が空でも、その旨を伝えて終了してください
    - 同じクエリを繰り返さないでください
    - **DuckDB制約**: WITH句（CTE）でUPDATE/INSERTは使えない。UPDATE と INSERT は別々のツール呼び出しで実行すること
    - **1回のツール呼び出し = 1つのSQL文**。複数のSQL文をセミコロンで結合しないこと

    ## スキーマ

    staff (id, name, name_reading, role_ja, skills[], availability JSON, phone, line_id, notes)
    shifts (shift_id, staff_id, staff_name, date, start_time, end_time, status, created_at, cancelled_at, cancel_reason, swapped_from, swapped_at)
    swap_requests (swap_id, shift_id, original_staff_id, original_staff_name, date, start_time, end_time, reason, status, approved_staff_id, approved_staff_name, approved_at)

    ## SQL例

    -- 今日のシフト
    SELECT staff_name, start_time, end_time FROM shifts WHERE date = CURRENT_DATE AND status = 'confirmed'

    -- スタッフ一覧
    SELECT name, role_ja, phone FROM staff

    -- シフト作成
    INSERT INTO shifts VALUES ('SH001', 'tanaka', '田中太郎', '2026-02-10', '09:00', '17:00', 'confirmed', NOW(), NULL, NULL, NULL, NULL)

    -- キャンセル（休みになった場合は必ずUPDATE実行）
    UPDATE shifts SET status = 'cancelled', cancelled_at = NOW(), cancel_reason = '体調不良' WHERE staff_id = 'tanaka' AND date = CURRENT_DATE + 1

    -- 月曜出勤可能なスタッフ
    SELECT name, phone FROM staff WHERE availability LIKE '%mon%'

    -- 交代リクエスト登録
    INSERT INTO swap_requests VALUES ('SW_new', 'SH068', 'yamada', '山田美咲', CURRENT_DATE + 1, '18:00', '22:00', '予定が入った', 'pending', NOW(), NULL, NULL, NULL)

    ## 重要なワークフロー

    **シフト交代・休み対応:**
    1. まず shift_manager で該当シフトをUPDATE（status='cancelled'）
    2. 次に shift_table_generator を呼ぶ。**必ず overrides パラメータ**で変更内容を渡す
       例: overrides='{"cancelled": [{"staff_id": "tanaka", "date": "2026-02-17"}]}'
       交代者がいる場合は added も追加:
       overrides='{"cancelled": [{"staff_id": "tanaka", "date": "2026-02-17"}], "added": [{"staff_id": "kobayashi", "name": "小林花子", "date": "2026-02-17", "start": "06:00", "end": "15:00"}]}'
    3. 必要に応じて line_composer で交代依頼メッセージを作成
    4. dashboard_template で更新後のシフト表を描画

    **重要**: shift_table_generator に overrides を渡さないとシフト表に変更が反映されない。
parameters:
  - name: sql
    type: string
    required: true
    label:
      en_US: SQL
      ja_JP: SQL
    human_description:
      en_US: "SQL query to execute"
      ja_JP: "実行するSQLクエリ"
    llm_description: "実行するSQL（DuckDB構文。1回に1つのSQL文のみ。CTE+UPDATEは不可）"
    form: llm
extra:
  python:
    source: tools/shift_manager.py
